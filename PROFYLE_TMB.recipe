BootStrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/x86_64/
Include: yum

%runscript
    echo "This container holds the tools and resources required for the PROFYLE TMB work. \
    	 It should be orchestrated using the associated nextflow scripts."
    
%post
    mkdir /usr/TMB
    cd /usr/TMB
    
    yum -y update 
    yum -y install wget unzip tar bzip2 java-1.8.0-openjdk
    yum -y install zlib-devel ncurses-devel ncurses
    yum -y install libgomp
    yum -y install make
    yum -y install gcc
    yum -y install bc

    #install fastp
    wget http://opengene.org/fastp/fastp
    chmod a+x ./fastp

    #install strelka2.9.2
    wget https://github.com/Illumina/strelka/releases/download/v2.9.2/strelka-2.9.2.centos6_x86_64.tar.bz2
    tar xvjf strelka-2.9.2.centos6_x86_64.tar.bz2
    #run install tests
    # bash strelka-2.9.2.centos6_x86_64/bin/runStrelkaSomaticWorkflowDemo.bash
    # bash strelka-2.9.2.centos6_x86_64/bin/runStrelkaGermlineWorkflowDemo.bash 

    #install Manta for SV calls, and upstream Strelka calling
    wget https://github.com/Illumina/manta/releases/download/v1.6.0/manta-1.6.0.centos6_x86_64.tar.bz2
    tar xvjf manta-1.6.0.centos6_x86_64.tar.bz2

    #run a small tests in Manta
    # python manta-1.6.0.centos6_x86_64/bin//runMantaWorkflowDemo.py

    #bedtools
    wget https://github.com/arq5x/bedtools2/releases/download/v2.29.2/bedtools.static.binary
    chmod 775 bedtools.static.binary

    #seqtk for counting fasta bases quickly
    wget https://github.com/lh3/seqtk/archive/v1.3.tar.gz
    tar -xvf v1.3.tar.gz
    cd seqtk-1.3/
    make
    cd /usr/TMB

    #install snpEff
    wget https://cfhcable.dl.sourceforge.net/project/snpeff/snpEff_v4_3t_core.zip
    unzip snpEff_v4_3t_core.zip
   
    #Set up Ensembl 75 GRCh37 database (will take a few minutes)
    java -jar /usr/TMB/snpEff/snpEff.jar download GRCh37.75 
    #extract the stats for the annotations - needs about 16Gb od RAM so this won't build on singularityhub where the RAM limit is 3.5Gb.
    java -jar /usr/TMB/snpEff/snpEff.jar dump -v -bed GRCh37.75 > GRCh37.75.bed
    #get the size of the CDS
    grep -E '^[1234567890XY]{1,2}\s' GRCh37.75.bed | grep CDS | ./bedtools.static.binary sort | ./bedtools.static.binary merge | awk '{ print $3-$2 }' | paste -sd+ | bc > CDS_size.txt
    
    #msisensor install - would be nice to scan the reference at setup, but it needs to match the reference supplied at runtime.
    wget https://github.com/ding-lab/msisensor/releases/download/0.2/msisensor.linux
    chmod 775 msisensor.linux
    wget https://www.bcgsc.ca/downloads/rcorbett/TMB/microsatellites.rep1

%environment
    export PATH=/usr/TMB:$PATH
    #export LC_ALL=C
